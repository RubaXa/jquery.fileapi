/*! jquery.fileapi 0.1.4 - MIT | git://github.com/rubaxa/jquery.fileapi.git */
(function(e,t){"use strict";function i(e){var t;for(t in e)if(e.hasOwnProperty(t)&&!(e[t]instanceof Object||"overlay"===t))return!0;return!1}var s=e.noop,n=!e.fn.prop,o=n?"attr":"prop",r="data-fileapi",a="data-fileapi-id",l=[].slice,h=function(e,t){var i=l.call(arguments,2);return t.bind?t.bind.apply(t,[e].concat(i)):function(){return t.apply(e,i.concat(l.call(arguments)))}},p=function(e){return"["+r+'="'+e+'"]'},u=function(i,n){if(this.$el=i=e(i).on("change.fileapi",h(this,this._onSelect)),this.el=i[0],this._options={},this.options=n=e.extend({url:0,data:{},accept:0,multiple:!1,paramName:0,dataType:"json",duplicate:!1,chunkSize:0,chunkUploadRetry:3,maxSize:0,maxFiles:0,imageSize:0,sortFn:0,filterFn:0,autoUpload:!1,clearOnSelect:void 0,clearOnComplete:void 0,lang:{B:"bytes",KB:"KB",MB:"MB",GB:"GB",TB:"TB"},sizeFormat:"0.00",imageTransform:0,imageAutoOrientation:!!FileAPI.support.exif,elements:{ctrl:{upload:p("ctrl.upload"),reset:p("ctrl.reset"),abort:p("ctrl.abort")},empty:{show:p("empty.show"),hide:p("empty.hide")},emptyQueue:{show:p("emptyQueue.show"),hide:p("emptyQueue.hide")},active:{show:p("active.show"),hide:p("active.hide")},size:p("size"),name:p("name"),progress:p("progress"),file:{tpl:p("file.tpl"),progress:p("file.progress"),active:{show:p("active.show"),hide:p("active.hide")},preview:{el:0,get:0,width:0,height:0,processing:0}},dnd:{el:p("dnd"),hover:"dnd_hover",fallback:p("dnd.fallback")}},onDrop:s,onDropHover:s,onSelect:s,onUpload:s,onProgress:s,onComplete:s,onFileUpload:s,onFileProgress:s,onFileComplete:s},n),!n.url){var o=this.$el.attr("action")||this.$el.find("form").attr("action");o?n.url=o:this._throw("url — is not defined")}this.$files=this.elem("list"),this.itemTplFn=e.fn.fileapi.tpl(e("<div/>").append(this.elem("file.tpl")).html()),t.each(n,function(e,t){this._setOption(t,e)},this),this.$el.on("reset.fileapi",h(this,this._onReset)).on("submit.fileapi",h(this,this._onSubmit)).on("upload.fileapi progress.fileapi complete.fileapi",h(this,this._onUploadEvent)).on("fileupload.fileapi fileprogress.fileapi filecomplete.fileapi",h(this,this._onFileUploadEvent)).on("click","["+r+"]",h(this,this._onActionClick));var a=n.elements.ctrl;a&&(a.reset&&this.$el.on("click.fileapi",a.reset,h(this,this._onReset)),a.upload&&this.$el.on("click.fileapi",a.upload,h(this,this._onSubmit)));var l=FileAPI.support.dnd;this.elem("dnd.el",!0).toggle(l),this.elem("dnd.fallback").toggle(!l),l&&this.elem("dnd.el",!0).dnd(h(this,this._onDropHover),h(this,this._onDrop)),this.$progress=this.elem("progress"),void 0===n.clearOnSelect&&(n.clearOnSelect=!n.multiple),this.clear()};u.prototype={constructor:u,_throw:function(e){throw"jquery.fileapi: "+e},_getFiles:function(e,i){var s=this.options,n=s.maxSize,o=s.filterFn,r=t.getFiles(e),a={all:r,files:[],other:[],duplicate:s.duplicate?[]:this._extractDuplicateFiles(r)},l=s.imageSize,h=this;l||o?t.filterFiles(r,function(e,t){var i=!0;return t&&l&&(i=(!l.minWidth||t.width>=l.minWidth)&&(!l.minHeight||t.height>=l.minHeight)&&(!l.maxWidth||t.height<=l.maxWidth)&&(!l.maxHeight||t.height<=l.maxHeight)),i&&(!n||n>=e.size)&&(!o||o(e,t))},function(e,t){a.files=e,a.other=t,i.call(h,a)}):(t.each(r,function(e){a[!n||n>=e.size?"files":"other"].push(e)}),i.call(h,a))},_extractDuplicateFiles:function(e){for(var t,i=[],s=e.length,n=this.files;s--;)for(t=n.length;t--;)if(this._fileCompare(e[s],n[t])){i.push(e.splice(s,1));break}return i},_fileCompare:function(e,t){return e.size==t.size&&e.name==t.name},_getFormatedSize:function(e){var i=this.options,s="B";return e>=t.TB?e/=t[s="TB"]:e>=t.GB?e/=t[s="GB"]:e>=t.MB?e/=t[s="MB"]:e>=t.KB&&(e/=t[s="KB"]),i.sizeFormat.replace(/^\d+([^\d]+)(\d*)/,function(t,n,o){return e=e.toFixed(o.length),(e+"").replace(".",n)+" "+i.lang[s]})},_onSelect:function(e){this._getFiles(e,h(this,function(e){e.all.length&&this.emit("select",e)!==!1&&this.add(e.files,this.options.resetOnSelect)}))},_onActionClick:function(i){var s=i.currentTarget,n=e.attr(s,r),o=e(s).closest("["+a+"]",this.$el),l=o.attr(a),h=!0;"remove"==n?(o.remove(),this.queue=t.filter(this.queue,function(e){return t.uid(e)!=l}),this.files=t.filter(this.files,function(e){return t.uid(e)!=l}),this._redraw()):/^rotate/.test(n)?this.rotate(l,/ccw/.test(n)?"-=90":"+=90"):h=!1,h&&i.preventDefault()},_onSubmit:function(e){this.upload(),e.preventDefault()},_onReset:function(e){this.clear(),e.preventDefault()},_onDrop:function(e){this._getFiles(e,function(e){this.emit("drop",e)!==!1&&this.add(e.files)})},_onDropHover:function(t,i){if(this.emit("dropHover",{state:t,event:i})!==!1){var s=this.option("elements.dnd.hover");s&&e(i.currentTarget).toggleClass(s,t)}},_getUploadEvent:function(t){var i=this.xhr,s={xhr:i,file:i.currentFile,files:i.files,widget:this};return e.extend(s,t)},_emitUploadEvent:function(e){var t=this._getUploadEvent();this.emit(e+"upload",t)},_emitProgressEvent:function(e,t){var i=this._getUploadEvent(t);this.emit(e+"progress",i)},_emitCompleteEvent:function(t,i){var s=this.xhr,n=this._getUploadEvent({error:i,status:s.status,statusText:s.statusText,result:s.responseText});"json"==this.options.dataType&&(n.result=e.parseJSON(n.result)),this.emit(t+"complete",n)},_onUploadEvent:function(e,t){var i=this,s=i.$progress,n=e.type;if("progress"==n)s.stop().animate({width:100*(t.loaded/t.total)+"%"},300);else if("upload"==n)s.width(0);else{var o=function(){s.dequeue(),i[i.options.clearOnComplete?"clear":"dequeue"]()};this.xhr=null,this.active=!1,s.length?s.queue(o):o()}},_onFileUploadPrepare:function(s,n){var o=t.uid(s),r=this._rotate[o],a=this._crop[o];if(r||a){var l=n.imageTransform=n.imageTransform||{};e.isEmptyObject(l)||i(l)?(l.crop=a,l.rotate=r):t.each(l,function(e){e.crop=a,e.rotate=r})}},_onFileUploadEvent:function(e,i){var s=this,n=e.type.substr(4),o=t.uid(i.file),a=this.fileElem(o),l=this._$fileprogress;if(this.__fileId!==o&&(this.__fileId=o,this._$fileprogress=l=a.find(this.option("elements.file.progress"))),"progress"==n)l.stop().animate({width:100*(i.loaded/i.total)+"%"},300);else if("upload"==n||"complete"==n){var h=function(){var e="elements.file."+n;"upload"==n&&(a.find("["+r+'="remove"]').hide(),l.width(0)),l.dequeue(),a.find(s.option(e+".show")).show(),a.find(s.option(e+".hide")).hide()};l.length?l.queue(h):h(),"complete"==n&&(this.uploaded.push(i.file),delete this._rotate[o])}},_redraw:function(){var i=!!this.active,s=this.files,n=!s.length&&!i,r=!this.queue.length&&!i,l=[],h=0,p=this.$files,u=p.children().length,c=this.option("elements.file.preview");t.each(s,function(i,s){var n=t.uid(i);if(l.push(i.name),h+=i.size,p.length&&!this.fileElem(n).length){var o=this.itemTplFn({$idx:u+s,uid:i.uid,name:i.name,type:i.type,size:i.size,sizeText:this._getFormatedSize(i.size)});p.append(e(o).attr(a,n)),c.el&&this._makeFilePreview(n,i,c)}},this),this.elem("name").text(l.join(", ")),this.elem("size").text(this._getFormatedSize(h)),this.__empty!==n&&(this.__empty=n,this.elem("empty.show").toggle(n),this.elem("empty.hide").toggle(!n)),this.__emptyQueue!==r&&(this.__emptyQueue=n,this.elem("emptyQueue.show").toggle(r),this.elem("emptyQueue.hide").toggle(!r)),this.__active!==i&&(this.__active=i,this.elem("active.show").toggle(i),this.elem("active.hide").toggle(!i),this.$(".js-fileapi-wrapper,:file")[i?"attr":"removeAttr"]("aria-disabled",i)[o]("disabled",i)),this.elem("ctrl.upload").add(this.elem("ctrl.reset"))[n||i?"attr":"removeAttr"]("aria-disabled",n||i)[o]("disabled",n||i)},_makeFilePreview:function(e,i,s,n){var o=this,r=n?o.$(s.el):o.fileElem(e).find(s.el);if(/^image/.test(i.type)){t.log("_makeFilePreview:",e,i);var a=t.Image(i),l=function(){a.get(function(t,n){o._crop[e]||(t?(s.get&&s.get(r,i),o.emit("filePreviewError",{error:t,file:i})):r.html(n))})};s.width&&a.preview(s.width,s.height),s.rotate&&a.rotate(s.rotate),s.processing?s.processing(i,a,l):l()}else s.get&&s.get(r,i)},emit:function(t,i){var s,n=this.options,o=e.Event(t);return o.widget=this,t=e.camelCase("on-"+t.replace(/(file)(upload)/,"$1-$2")),e.isFunction(n[t])&&(s=n[t].call(this.el,o,i)),s!==!1&&this.$el.triggerHandler(o,i)},add:function(e,i){if(e=[].concat(e),e.length){var s=this.options,n=s.sortFn,o=s.elements.preview;n&&e.sort(n),o&&o.el&&t.each(e,function(e){this._makeFilePreview(t.uid(e),e,o,!0)},this),this.xhr&&this.xhr.append(e),this.queue=i?e:this.queue.concat(e),this.files=i?e:this.files.concat(e),this.options.autoUpload?this.upload():this._redraw()}},$:function(t,i){return"string"==typeof t&&(t=/^#/.test(t)?t:(i?e(i):this.$el).find(t)),e(t)},elem:function(t,i){var s=this.option("elements."+t);return void 0===s&&i&&(s=this.option("elements."+t.substr(0,t.lastIndexOf(".")))),this.$("string"!=e.type(s)&&e.isEmptyObject(s)?[]:s)},fileElem:function(e){return this.$("["+a+'="'+e+'"]')},option:function(i,s){if(void 0!==s&&e.isPlainObject(s))return t.each(s,function(e,t){this.option(i+"."+t,e)},this),this;var n,o,r=this.options,a=r[i],l=0;if(-1!=i.indexOf("."))for(a=r,i=i.split("."),n=i.length;n>l;l++){if(o=i[l],void 0!==s&&1===n-l){a[o]=s;break}void 0===a[o]&&(a[o]={}),a=a[o]}else void 0!==s&&(r[i]=s);return void 0!==s&&(this._setOption(i,s,this._options[i]),this._options[i]=s),void 0!==s?s:a},_setOption:function(e,t){switch(e){case"accept":case"multiple":case"paramName":"paramName"==e&&(e="name"),t&&this.$(":file")[o](e,t)}},serialize:function(){var t,i={};return this.$el.find(":input").each(function(s,n){(s=n.name)&&!n.disabled&&(n.checked||/select|textarea|input/i.test(n.nodeName)&&/checkbox|radio/i.test(n.type))&&(t=e(n).val(),void 0!==i[s]?(i[s].push||(i[s]=[i[s]]),i[s].push(t)):i[s]=t)}),i},upload:function(){if(!this.active){this.active=!0;var i=this.$el,s=this.options,n={},o={url:s.url,data:e.extend({},this.serialize(),s.data),headers:s.headers,files:n,chunkSize:0|s.chunkSize,chunkUploadRetry:0|s.chunkUploadRetry,prepare:h(this,this._onFileUploadPrepare),imageTransform:s.imageTransform};n[i.find(":file").attr("name")||"files[]"]=this.queue,t.each(["upload","progress","complete"],function(t){o[t]=h(this,this[e.camelCase("_emit-"+t+"Event")],""),o["file"+t]=h(this,this[e.camelCase("_emit-"+t+"Event")],"file")},this),this.xhr=t.upload(o),this._redraw()}},crop:function(i,s){var n=t.uid(i),o=this.options,r=o.multiple?this.option("elements.file.preview"):o.elements.preview,a=(o.multiple?this.fileElem(n):this.$el).find(r&&r.el);a.length&&t.getInfo(i,h(this,function(n,l){if(!n){a.find("div>div").length||a.html(e("<div><div></div></div>").css(r).css("overflow","hidden")),this.__cropFile!==i&&(this.__cropFile=i,t.Image(i).rotate(o.imageAutoOrientation?"auto":0).get(function(t,i){a.find(">div>div").html(e(i).width("100%").height("100%"))},"exactFit"));var h=r.width/s.w,p=r.height/s.h;a.find(">div>div").css({width:Math.round(h*l.width),height:Math.round(p*l.height),marginLeft:-Math.round(h*s.x),marginTop:-Math.round(p*s.y)})}})),this._crop[n]=s},rotate:function(e,i){var s="object"==typeof e?t.uid(e):e,n=this.options,o=n.multiple?this.option("elements.file.preview"):n.elements.preview,r=(n.multiple?this.fileElem(s):this.$el).find(o&&o.el),a=this._rotate;/([+-])=/.test(i)?i=a[s]=(a[s]||0)+("+"==RegExp.$1?1:-1)*i.substr(2):a[s]=i,r.css({"-webkit-transform":"rotate("+i+"deg)","-moz-transform":"rotate("+i+"deg)",transform:"rotate("+i+"deg)"})},clear:function(){this._crop={},this._rotate={},this.queue=[],this.files=[],this.uploaded=[],this.$files.empty(),this._redraw()},dequeue:function(){this.queue=[],this._redraw()},widget:function(){return this},destroy:function(){this.$el.off(".fileapi").removeData("fileapi")}},e.fn.fileapi=function(t,i){var s=this.data("fileapi");if(s){if("widget"===t)return s;if("string"==typeof t){var n,o=s[t];return e.isFunction(o)?n=o.call(s,i,arguments[2]):void 0===o&&(n=this.option(t,i)),void 0===n?this:n}}else this.data("fileapi",new u(this,t));return this},e.fn.fileapi.version="0.1.4",e.fn.fileapi.tpl=function(e){var t=0,i="__b+='";return e.replace(/(?:&lt;|<)%([-=])?([\s\S]+?)%(?:&gt;|>)|$/g,function(s,n,o,r){return i+=e.slice(t,r).replace(/[\r\n"']/g,function(e){return"\\"+e}),o&&(i+=n?"'+\n((__x=("+o+"))==null?'':"+("-"==n?"__esc(__x)":"__x")+")\n+'":"';\n"+o+"\n__b+='"),t=r+s.length,s}),Function("ctx","var __x,__b='',__esc=function(val){return typeof val=='string'?val.replace(/</g,'&lt;').replace(/\"/g,'&quot;'):val;};with(ctx||{}){\n"+i+"';\n}return __b;")},e.fn.webcam=function(i){var n=this,o=n,r=e(n),a="fileapi-camera",l=r.data(a);return l===!0?(t.log("[webcam.warn] not ready."),o=null):"widget"===i?o=l:"destroy"===i?(l.stop(),r.empty()):l?o=l[i]():l===!1?(t.log("[webcam.error] вoes not work."),o=null):(r.data(a,!0),i=e.extend({success:s,error:s},i),FileAPI.Camera.publish(r,i,function(e,t){r.data(a,e?!1:t),i[e?"error":"success"].call(n,e||t)})),o},e.fn.cropper=function(i){var s=this,n=i.file;return"string"==typeof i?s.first().Jcrop.apply(s,arguments):t.getInfo(n,function(o,r){var a=t.Image(n);i.maxSize&&a.resize(i.maxSize[0],i.maxSize[1],"max"),a.rotate("auto").get(function(n,o){var a=i.selection,l=Math.min(o.width,o.height),h=l,p=l/(i.aspectRatio||1);if(a){(/%/.test(a)||a>0&&1>a)&&(a=parseFloat(a,10)/(a>0?1:100),h*=a,p*=a);var u=(o.width-h)/2,c=(o.height-p)/2;i.setSelect=[0|u,0|c,0|u+h,0|c+p]}t.each(["onSelect","onChange"],function(e,t){(t=i[e])&&(i[e]=function(e){var i=r.width/o.width,s=r.height/o.height;t({x:0|e.x*i+.5,y:0|e.y*s+.5,w:0|e.w*i+.5,h:0|e.h*s+.5})})});var d=e("<div/>").css("lineHeight",0).append(e(o).css("margin",0));s.html(d),d.Jcrop(i).trigger("resize")})}),s}})(jQuery,FileAPI);